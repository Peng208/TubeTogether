{"version":3,"sources":["app.js"],"names":["_slicedToArray","sliceIterator","arr","i","_arr","_n","_d","_e","undefined","_s","_i","Symbol","iterator","next","done","push","value","length","err","Array","isArray","Object","TypeError","window","YT2gether","stopInit","event","startAt","countdownTimer","_deltaTime","Date","calcRemainingTime","_timeBase","clearTimeout","refeshTimer","roughTime","time","timeBase","map","base","idx","timeLimitation","forEach","t","timeUnit","document","documentElement","setAttribute","setTimeout","initYoutube","generator","dialog","el","data","location","origin","pathname","patterns","YMDTHM","THMS","form","getElementsByClassName","_slice$call","slice","call","getElementsByTagName","_slice$call2","listid","chatroom","resultLink","querySelector","_slice$call3","querySelectorAll","_slice$call4","shareBtnFB","shareBtnTwitter","urlTpl","fb","getAttribute","tw","updateLink","checkValidity","console","log","_time","test","url","innerHTML","href","replace","encodeURI","encodeURIComponent","now","getTimezoneOffset","toISOString","split","addEventListener","style","display","search","_search","substr","_uq","listId","list","vId","v","fetch","then","response","json","posts","body","match","content","confirm","API_KEY","YOUTUBE_API_URL","DURATION_UNIT","H","M","S","initChatroom","chatIframe","createElement","src","appendChild","getYTduration","timeString","dura","_dura$match","_dura$match2","unit","reduce","a","b","res","_totalDuration","items","contentDetails","duration","player","YT","Player","videoId","playerVars","autoplay","start","item","join","listString","durations","_durationsTempSum","durationsStack","totalDuration","timer","deltaTime","startTime","listType","state","index"],"mappings":"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","file":"app.js","sourcesContent":["/* globals YT, fetch, YT2gether, location */\n\nwindow.YT2gether = {\n  stopInit: false,\n  event: 'postCSS',\n  startAt: null\n};\n\nYT2gether.countdownTimer = () => {\n  let _deltaTime = new Date(YT2gether.startAt) - new Date();\n  let countdownTimer;\n  let calcRemainingTime = () => {\n    let _timeBase;\n\n    _deltaTime = (new Date(YT2gether.startAt) - new Date()) / 1e3;\n\n    clearTimeout(YT2gether.refeshTimer);\n    countdownTimer.roughTime = null;\n\n    countdownTimer.time = countdownTimer.timeBase.map((base, idx) => {\n      return _deltaTime / base % countdownTimer.timeLimitation[idx] | 0;\n    });\n\n    countdownTimer.time.forEach((t, i) => {\n      if (!countdownTimer.roughTime && t) {\n        _timeBase = countdownTimer.timeBase[i];\n        countdownTimer.roughTime = t + countdownTimer.timeUnit[i];\n      }\n    });\n\n    document.documentElement.setAttribute('data-countdown', 'Start after ~' + countdownTimer.roughTime);\n\n    if (_deltaTime < 60 * 1) {\n      YT2gether.refeshTimer = setTimeout(() => {\n        document.documentElement.setAttribute('data-countdown', 'Start!');\n        YT2gether.initYoutube();\n      }, _deltaTime * 1e3);\n    } else {\n      YT2gether.refeshTimer = setTimeout(() => {\n        calcRemainingTime();\n      }, _timeBase * 200);\n    }\n  };\n\n  // not begun yet\n  if (_deltaTime > 0) {\n    countdownTimer = {\n      timeUnit: 'dhms',\n      timeBase: [60 * 60 * 24, 60 * 60, 60, 1],\n      timeLimitation: [3650, 24, 60, 60]\n    };\n\n    calcRemainingTime();\n  }\n};\n\nYT2gether.generator = () => {\n  let dialog = {\n    el: {},\n    data: {\n      base: location.origin + location.pathname\n    }\n  };\n\n  let patterns = {\n    YMDTHM: /^\\d{4}(-\\d{2}){2}T\\d{2}:\\d{2}/,\n    THMS: /T\\d{2}:\\d{2}:\\d{2}$/\n  };\n\n  dialog.el.form = document.getElementsByClassName('dialog')[0];\n  [dialog.el.time, dialog.el.listid, dialog.el.chatroom] = [].slice.call(dialog.el.form.getElementsByTagName('input'));\n  dialog.el.resultLink = dialog.el.form.querySelector('.result a');\n  [dialog.el.shareBtnFB, dialog.el.shareBtnTwitter] = [].slice.call(dialog.el.form.querySelectorAll('.sharebtn'));\n\n  dialog.data.urlTpl = {\n    fb: dialog.el.shareBtnFB.getAttribute('data-url'),\n    tw: dialog.el.shareBtnTwitter.getAttribute('data-url')\n  };\n\n  dialog.updateLink = () => {\n    if (!dialog.el.form.checkValidity()) {\n      console.log('form checkValidity false!');\n      return;\n    }\n\n    // check time format\n    let _time = dialog.el.time.value;\n    if (patterns.YMDTHM.test(_time)) {\n      dialog.data.time = _time += patterns.THMS.test(_time) ? '+08:00' : ':00+08:00';\n    } else {\n      // alert('false time value');\n    }\n\n    dialog.data.listid = dialog.el.listid.value;\n    dialog.data.chatroom = dialog.el.chatroom.value === '' ? '' : '&chatroom=' + dialog.el.chatroom.value;\n\n    let url = dialog.data.base + `?startAt=${dialog.data.time}&list=${dialog.data.listid}${dialog.data.chatroom}`;\n\n    dialog.el.resultLink.innerHTML = url;\n    dialog.el.resultLink.href = url;\n    dialog.el.shareBtnFB.href = dialog.data.urlTpl.fb.replace('${url}', encodeURI(url));\n    dialog.el.shareBtnTwitter.href = dialog.data.urlTpl.tw.replace('${url}', encodeURIComponent(url)).replace('${text}', dialog.data.time);\n\n  };\n\n  // init now time(GMT+8) format style\n  let now = new Date();\n  dialog.el.time.value = new Date(now - now.getTimezoneOffset() * 6e4).toISOString().split('.')[0];\n\n  dialog.updateLink();\n  dialog.el.form.addEventListener('input', dialog.updateLink);\n  dialog.el.form.style.display = 'block';\n};\n\n// get event info\nif (location.search.length) {\n  let _search = location.search.substr(1);\n\n  let _uq = {};\n  _search.split(/&/).forEach((i) => {\n    _uq[i.split(/=/)[0]] = i.split(/=/)[1] || '';\n  });\n\n  YT2gether.startAt = _uq.startAt;\n  YT2gether.listId = _uq.list;\n  YT2gether.vId = _uq.v;\n  YT2gether.new = (_uq.new === '');\n\n  YT2gether.chatroom = _uq.chatroom || 'https://gitter.im/f2etw/TubeTogether/~chat';\n\n  if (YT2gether.new) {\n    YT2gether.stopInit = true;\n    YT2gether.generator();\n  } else if (!YT2gether.startAt || (!YT2gether.listId && !YT2gether.vId)) {\n    YT2gether.stopInit = true;\n    location.href = location.origin + location.pathname;\n  } else {\n    YT2gether.countdownTimer();\n  }\n} else {\n  YT2gether.stopInit = true;\n\n  // update info from github issue\n  fetch('https://api.github.com/repos/f2etw/TubeTogether/issues?labels=living&state=open').then((response) => {\n    return response.json();\n  })\n  .then((posts) => {\n    if (/^\\?/.test(posts[0].body)) {\n      location.search = posts[0].body.match(/^\\?.+/)[0];\n    }\n  })\n  .catch((content) => {\n    if (window.confirm('GG 惹，請問要去 GitHub issue 確認一下有沒有新活動嗎？')) {\n      location.href = 'https://github.com/f2etw/TubeTogether/labels/living';\n    }\n    return 'GG';\n  });\n}\n\nconst API_KEY = 'AIzaSyDyZ231vqsztOc_f2rKwyedUOY9eEnq2lU';\nconst YOUTUBE_API_URL = 'https://www.googleapis.com/youtube/v3';\n\nconst DURATION_UNIT = {\n  'H': 60 * 60,\n  'M': 60,\n  'S': 1\n};\n\nYT2gether.initChatroom = () => {\n  if (YT2gether.stopInit || YT2gether.chatroom === 'none') { return; }\n\n  let chatIframe = document.createElement('iframe');\n  chatIframe.src = YT2gether.chatroom;\n  document.body.appendChild(chatIframe);\n};\n\nYT2gether.initYoutube = () => {\n  if (YT2gether.stopInit) { return; }\n\n  let getYTduration = (timeString) => {\n    return timeString.match(/\\d+\\w/gi).map((dura) => {\n      let [, time, unit] = dura.match(/(\\d+)(\\w)/);\n      return time * DURATION_UNIT[unit];\n    })\n    .reduce((a, b) => {\n      return a + b;\n    })\n  };\n\n  if (YT2gether.vId) {\n    fetch(`https://www.googleapis.com/youtube/v3/videos?id=${YT2gether.vId}&key=AIzaSyDYwPzLevXauI-kTSVXTLroLyHEONuF9Rw&part=contentDetails`)\n      .then((res) => {\n        return res.json();\n      })\n      .then((data) => {\n        let _totalDuration = getYTduration(data.items[0].contentDetails.duration);\n        let _deltaTime = (new Date() - new Date(YT2gether.startAt)) / 1e3 | 0;\n\n        // if event was over or not yet begun\n        if ((_deltaTime < 0 || _totalDuration < _deltaTime) && _totalDuration) {\n          return;\n        }\n\n        YT2gether.player = new YT.Player('player', {\n          videoId: YT2gether.vId,\n          playerVars: {\n            autoplay: 1,\n            start: _deltaTime\n          }\n        });\n      })\n  } else {\n    fetch(`${YOUTUBE_API_URL}/playlistItems?part=contentDetails&maxResults=50&playlistId=${YT2gether.listId}&key=${API_KEY}`)\n      .then((res) => {\n        return res.json();\n      })\n      .then((data) => {\n        return data.items.map((item) => {\n          return item.contentDetails.videoId;\n        }).join();\n      })\n      .then((listString) => {\n        return fetch(`${YOUTUBE_API_URL}/videos?part=contentDetails&maxResults=50&id=${listString}&key=${API_KEY}`)\n          .then((res) => {\n            return res.json();\n          });\n      })\n      .then((data) => {\n        let durations = data.items.map((item) => {\n          return getYTduration(item.contentDetails.duration);\n        });\n\n        let _durationsTempSum = 0;\n        let durationsStack = durations.map((time) => {\n          _durationsTempSum += time;\n          return _durationsTempSum;\n        });\n\n        let totalDuration = durationsStack.slice(-1)[0];\n\n        let timer = {};\n        timer.deltaTime = (new Date() - new Date(YT2gether.startAt)) / 1e3 | 0;\n\n        // if event was over or not yet begun\n        if (timer.deltaTime < 0 || totalDuration < timer.deltaTime) {\n          return;\n        }\n\n        let i = durationsStack.length - 1;\n        for (; i >= 0; i--) {\n          if (timer.deltaTime > durationsStack[i]) {\n            timer.startTime = timer.deltaTime - durationsStack[i];\n            break;\n          }\n        }\n\n        YT2gether.player = new YT.Player('player', {\n          playerVars: {\n            listType: 'playlist',\n            list: YT2gether.listId,\n            autoplay: 1,\n            start: timer.startTime,\n            state: 1,\n            index: i\n          }\n        });\n      });\n  }\n};\n\nYT2gether.initChatroom();\nYT2gether.initYoutube();\n"],"sourceRoot":"/source/"}